#!/usr/bin/env python3
"""
Quick test script to verify installation and setup

This runs a minimal test with just 10 problems to ensure everything works.
"""

import sys
from pathlib import Path

print("Testing saturation study setup...\n")

# Test imports
print("1. Testing imports...")
try:
    import torch
    import transformers
    import datasets
    import pandas as pd
    import numpy as np
    import matplotlib.pyplot as plt
    import seaborn as sns
    from tqdm import tqdm
    print("   ✓ All imports successful")
except ImportError as e:
    print(f"   ✗ Import error: {e}")
    print("\n   Please install requirements:")
    print("   pip install -r requirements.txt")
    sys.exit(1)

# Test CUDA
print("\n2. Testing CUDA availability...")
if torch.cuda.is_available():
    print(f"   ✓ CUDA available: {torch.cuda.get_device_name(0)}")
    print(f"   ✓ CUDA version: {torch.version.cuda}")
else:
    print("   ⚠ CUDA not available - will use CPU (very slow)")

# Test config
print("\n3. Testing configuration...")
try:
    from config import *
    print(f"   ✓ Config loaded")
    print(f"   ✓ Primary model: {PRIMARY_MODEL}")
    print(f"   ✓ Results directory: {RESULTS_DIR}")
except Exception as e:
    print(f"   ✗ Config error: {e}")
    sys.exit(1)

# Test utilities
print("\n4. Testing utilities...")
try:
    from utils import *
    print("   ✓ Utils loaded")
except Exception as e:
    print(f"   ✗ Utils error: {e}")
    sys.exit(1)

# Run mini experiment
print("\n5. Running mini experiment (10 problems, 2 budgets)...")
print("   This will test model loading and generation...\n")

try:
    # Import phase1 runner
    from phase1_main import run_experiment
    
    # Run with minimal settings
    results = run_experiment(
        model_name=PRIMARY_MODEL,
        budgets=[128, 256],
        dataset_name='gsm8k',
        num_samples=10,  # Just 10 problems
        seed=42
    )
    
    print("\n   ✓ Mini experiment completed!")
    print(f"   ✓ Results saved to {RESULTS_DIR}")
    
    # Check results
    if 128 in results and 256 in results:
        acc_128 = sum(r['correct'] for r in results[128]) / len(results[128])
        acc_256 = sum(r['correct'] for r in results[256]) / len(results[256])
        print(f"\n   Results on 10 problems:")
        print(f"     Budget 128: {acc_128:.0%} accuracy")
        print(f"     Budget 256: {acc_256:.0%} accuracy")
    
except Exception as e:
    print(f"\n   ✗ Experiment error: {e}")
    import traceback
    traceback.print_exc()
    sys.exit(1)

print("\n" + "="*60)
print("✓ ALL TESTS PASSED!")
print("="*60)
print("\nYour setup is ready. You can now run:")
print("  python run_all.py --all")
print("\nOr for a quick test with limited samples:")
print("  python run_all.py --all --num-samples 100")
print("\nSee README.md for detailed instructions.")
print("="*60 + "\n")